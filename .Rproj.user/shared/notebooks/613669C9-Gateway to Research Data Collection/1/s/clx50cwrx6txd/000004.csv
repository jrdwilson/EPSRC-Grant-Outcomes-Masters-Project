"0","# define the data collection function"
"0","get_project_info <- function(i) {"
"0","  tryCatch("
"0","    {"
"0","      # extract the project URL"
"0","      project_url <<- project_df$gtr_project_url[i]"
"0","      "
"0","      # extract the project reference number for use in the other dataframes"
"0","      project_ref <<- project_df$project_reference[i]"
"0","      "
"0","      # check and correct for faulty urls by rebuilding them"
"0","      project_type <<- project_df$project_category[i]"
"0","      "
"0","      if (project_type == ""Studentship"") {"
"0","        # build correct Studentship URL with project ref number"
"0","        project_url <<- paste("
"0","          ""https://gtr.ukri.org/projects?ref=studentship-"", "
"0","          project_ref, "
"0","          collapse = """", "
"0","          sep = """""
"0","        )"
"0","        # save corrected URL in dataframe"
"0","        project_df$gtr_project_url[i] <- project_url"
"0","      } else {"
"0","        # build correct Studentship URL with project ref number"
"0","        project_url <<- paste("
"0","          ""https://gtr.ukri.org/projects?ref="", "
"0","          project_ref, "
"0","          collapse = """", "
"0","          sep = """""
"0","        )"
"0","        # save corrected URL in dataframe"
"0","        project_df$gtr_project_url[i] <<- project_url"
"0","      }"
"0","      "
"0","      start_time <<- Sys.time()"
"0",""
"0","      project_info <<- fromJSON("
"0","        project_url,"
"0","        simplifyDataFrame = TRUE,"
"0","        flatten = TRUE)"
"0","      "
"0","      end_time <<- Sys.time()"
"0","      "
"0","      # calculate wait time"
"0","      wait_time <<- end_time - start_time"
"0","      "
"0","      # extract abstract and assign it to the relevant cell"
"0","      abstract <<- project_info$projectOverview$projectComposition$project$abstractText"
"0","      project_df$abstract[i] <<- abstract"
"0","      "
"0","      # add to person df"
"0","      personRole <<- as_tibble(project_info$projectOverview$projectComposition$personRole) %>% "
"0","        add_column(project.ref = project_ref, .before = 1)"
"0","      "
"0","      person_df <<- person_df %>% bind_rows(personRole)"
"0","      "
"0","      # add to organisation df"
"0","      organisationRole <- as_tibble(project_info$projectOverview$projectComposition$organisationRole) %>% "
"0","        add_column(project.ref = project_ref, .before = 1)"
"0","      "
"0","      organisation_df <<- organisation_df %>% bind_rows(organisationRole)"
"0","      "
"0","      # add to research_subject df"
"0","      researchSubject <- as_tibble(project_info$projectOverview$projectComposition$project$researchSubject) %>% "
"0","        add_column(project.ref = project_ref, .before = 1)"
"0","      "
"0","      subject_df <<- subject_df %>% bind_rows(researchSubject)"
"0","      "
"0","      # add to research_topic df"
"0","      researchTopic <- as_tibble(project_info$projectOverview$projectComposition$project$researchTopic) %>% "
"0","        add_column(project.ref = project_ref, .before = 1)"
"0","      "
"0","      topic_df <<- topic_df %>% bind_rows(researchTopic)"
"0","      "
"0","      # log successful data collection"
"0","      log_print("
"0","        str_glue(""Data collected from {project_url} successfully in {round(as.numeric(wait_time),6)} seconds""), "
"0","        console = FALSE"
"0","      )"
"0","      "
"0","    },"
"0","    error=function(cond) {"
"0","      # log the error in the dataframe for collection later"
"0","      error_project_df <<- error_project_df %>% add_row(i = i, url = project_url)"
"0","      "
"0","      error_time <- format(Sys.time(), ""%H:%M:%S"")"
"0","      # log unsuccessful data collection with details of issue"
"0","      log_print(str_glue(""Data collection from {project_url} at {error_time} failed: \n {cond} \n Waiting 5 minutes before resuming.""))"
"0","      "
"0","      # set the wait time to 5 minutes."
"0","      wait_time <<- 300"
"0","    },"
"0","    finally = {"
"0","      # update progress bar to monitor process"
"0","      prog_bar$tick()"
"0","      "
"0","      # wait the calculated time"
"0","      Sys.sleep(wait_time)"
"0","    }"
"0","  )"
"0","}"
